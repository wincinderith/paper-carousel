<!doctype html>
<!--
paper-carousel, a Polymer element that displays a Material Design image carousel.
Copyright (C) 2016  Kevin Boxhoorn

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<link rel="import" href="../iron-image-info/iron-image-info.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../polymer/polymer.html">

<!--
Polymer element that displays a Material Design image carousel. You can supply
the data for the carousel either as an array through the `data` attribute, or a
URL to a JSON file through the `src` attribute.

    <paper-carousel src="carousel.json"></paper-carousel>

The JSON should be formatted as follows:

    [
        {
            "title": "example title",
            "info": "example information.",
            "image": "example.png",
            "link": "//www.example.com/"
        },
        {
            "title": "another example title",
            "info": "more example information.",
            "image": "example.png",
            "link": "//www.example.org/"
        }
    ]

`"link"` is optional and adds a link on the image when it becomes selected,
whereas `"title"`, `"info"` and `"image"` are mandatory and are passed directly
to the respective `iron-image-info`. The link's target can be set with the
`link-target` attribute. It defaults to `"_self"`.

By default the carousel will automatically rotate, but this can be disabled by
setting the `auto` attribute. The speed of rotation can be altered by changing
`auto-time` to a time in milliseconds.

The aspect ratio of the images can be set using the `aspectRatio` property of
the element. Values should be in the format `"16:9"`.

There should only be a maximum of 3 images in the carousel at a time, but more
than that will work with limited functionality when `auto` is set to `true`.
This will be revised upon in the future for more responsiveness and flexibility.

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--paper-carousel` | Mixin applied to the element's host | `{}`
`--paper-carousel-image` | Mixin applied to the carousel's `iron-image-info`s | `{}`
@demo
-->
<dom-module id="paper-carousel">
	<style>
		:host {
			@apply(--paper-carousel);
			display: block;
		}

		@media only screen and (min-width: 752px) {
			:host {
				width: 100%;
				position: relative;
			}
			:host:after {
				display: block;
				padding-top: var(--paper-carousel-aspect-ratio);
				content: "";
			}

			:host:hover iron-image-info.selected {
				width: calc(66% - 16px);
				top: calc(50% - 33%); left: calc(50% - 33%);
			}
			:host:hover iron-image-info.unselected {
				display: none;
				width: calc(33% - 16px);
			}
			:host:hover iron-image-info.unselected.index-0 {
				display: initial;
				left: calc(50% + 33%);
			}
			:host:hover iron-image-info.unselected.index-1 {
				display: initial;
				right: calc(50% + 33%);
			}

			iron-image-info {
				@apply(--paper-carousel-image);
				--iron-image-info-image: {
					width: 100%;
				}
				overflow: none;
				position: absolute;
				transition: all .2s ease;
			}
			iron-image-info.selected {
				width: calc(100% - 16px);
				top: 0; left: 0;
			}
			iron-image-info.unselected {
				display: none;
				width: calc(33% - 16px);
				top: calc(50% - 16.5%);
			}
			iron-image-info.unselected.index-0 {
				display: initial;
				left: 100%;
			}
			iron-image-info.unselected.index-1 {
				display: initial;
				right: 100%;
			}

			paper-material {
				overflow: hidden;
				position: absolute;
				border-radius: 2px;
				top: 0; bottom: 0; left: 0; right: 0;
			}
		}
		@media only screen and (max-width: 752px) {
			:host {
				width: 100%;
			}

			iron-image-info {
				margin-bottom: 0;
			}
			iron-image-info:last-of-type {
				margin-bottom: 8px;
			}
			paper-material {
				border-radius: 2px;
			}
		}
	</style>

	<template>
		<paper-material elevation="[[elevation]]">
			<template is="dom-repeat" id="repeater" items="{{data}}">
				<iron-image-info class$="[[item.class]]" index$="[[index]]"
					href$="[[item.link]]" src$="[[item.image]]"
					title$="[[item.title]]" info$="[[item.info]]"
					link-target="{{linkTarget}}" index="{{index}}"
					on-iron-image-info-tap="_selectItem">
				</iron-image-info>
			</template>
		</paper-material>
	</template>
</dom-module>

<script>
	Polymer({
		is: "paper-carousel",

		properties: {
			/** Aspect ratio of the images in the carousel. */
			aspectRatio: {
				type: String,
				value: "16:9",
				observer: "_aspectRatioChanged"
			},
			/** Determines whether the carousel should automatically rotate. */
			auto: {
				type: Boolean,
				value: true
			},
			/** Sets the speed of automatic rotation in milliseconds. */
			autoTime: {
				type: Number,
				value: 5000,
				observer: "_autoTimeChanged"
			},
			/** The z-depth of this element, from 0-5. Passed onto [`paper-material`](https://elements.polymer-project.org/elements/paper-material). */
			elevation: {
				type: Number,
				value: 1
			},
			/** Data for the carousel, passed as a JSON array of objects. */
			data: {
				type: Array,
				value: [],
				observer: "_dataChanged"
			},
			/** The selected image. */
			selected: {
				type: Number,
				value: 0
			},
			/** URL to a JSON file, containing an array of objects. */
			src: {
				type: String,
				observer: "_srcChanged"
			},
			/** The target of the image links, bound to the anchor tags in
			   `iron-image-info`. */
			linkTarget: {
				type: String,
				value: "_self"
			},
			_autoInterval: {
				type: Object,
				value: null
			},
			_lastSelectedIndex: {
				type: Number,
				value: 0
			},
			_hover: {
				type: Boolean,
				value: false
			}
		},
		_aspectRatioChanged: function () {
			var matches = /^(\d+):(\d+)$/.exec(this.aspectRatio);
			var x = parseInt(matches[1]), y = parseInt(matches[2]);
			var z = y / (x / 100);
			this.customStyle["--paper-carousel-aspect-ratio"] = "calc("+z+"% + 8px)";
			this.updateStyles();
		},
		_autoTimeChanged: function () {
			window.clearInterval(this._autoInterval);
			this._autoInterval = null;
			this._startAutoInterval();
		},
		_dataChanged: function () {
			for (var i = 0; i < this.data.length; i++) {
				this.data[i].class = this._classForIndex(i);
			}
		},
		_srcChanged: function (newValue, oldValue) {
			var element = this;
			var xhr = new XMLHttpRequest();
			xhr.open("GET", newValue, true);
			xhr.addEventListener("readystatechange", function (e) {
				if (xhr.readyState == 4 && xhr.status == 200) {
					element.data = JSON.parse(xhr.responseText);
				}
			});
			xhr.send();
		},

		listeners: {
			"mouseover": "_mouseOver",
			"mouseout": "_mouseOut"
		},
		_mouseOver: function () {
			this._hover = true;
		},
		_mouseOut: function () {
			this._hover = false;
		},

		_isSelected: function (index) {
			return this.selected === index;
		},
		_classForIndex: function (index) {
			if (this._isSelected(index)) return "selected";

			var classPrefix = "";
			if (window.innerWidth > 752) {
				classPrefix = "link-disabled ";
			}
			if (index > this.selected) {
				return classPrefix + "unselected index-" + (index - 1);
			} else {
				return classPrefix + "unselected index-" + index;
			}
		},
		_selectItem: function (event) {
			var item = event.target;
			var index = item.index;
			var repeater = this.$.repeater;
			var selectedItem = this.$$(".selected");

			this.selected = index;
			repeater.modelForElement(selectedItem).set("item.class",
				this._classForIndex(selectedItem.index));
			repeater.modelForElement(item).set("item.class",
				this._classForIndex(index));
		},
		_startAutoInterval: function () {
			if (this._autoInterval === null) {
				this._autoInterval = window.setInterval(
					this.selectNextItem.bind(this),
					this.autoTime
				);
			}
		},
		/** Selects the next image in the carousel. */
		selectNextItem: function () {
			if (!this.auto || this._hover) {
				return;
			}

			if (this._lastSelectedIndex < this.data.length - 1) {
				this._lastSelectedIndex++;
			} else {
				this._lastSelectedIndex = 0;
			}
			this._selectItem({
				target: this.$$(
					"iron-image-info[index='" + this._lastSelectedIndex + "']"
				)
			});
		},

		attached: function () {
			window.addEventListener("resize", function () {
				this._dataChanged.bind(this)();
			}.bind(this));
			this._startAutoInterval();
		}
	});
</script>
